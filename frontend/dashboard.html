<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>AdminTruongTieuhocHuynhManDat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
  <script src="/main.js"></script>
  <script src="./bootstrap.bundle.min.js"></script>
</head>
<body>
  <div id="menuContainer"></div> <!-- N∆°i menu s·∫Ω ƒë∆∞·ª£c nh√©t v√†o -->

<script>
fetch("/menu.html")
  .then(response => response.text())
  .then(data => {
    document.getElementById("menuContainer").innerHTML = data;
  });
</script>
<div class="container mt-4">
  <div class="card shadow">
    <div class="card-body">
      <h5 class="card-title text-dark">üìà T·ªïng quan h·ªá th·ªëng</h5>
      <div class="row text-center text-dark">
        <div class="col-md-4">
          <h6>üîÅ L∆∞·ª£t truy c·∫≠p ng∆∞·ªùi d√πng</h6>
          <p id="statSessions" class="fw-bold fs-5">...</p>
        </div>
        <div class="col-md-4">
          <h6>üí¨ L∆∞·ª£t tra c·ª©u c√¢u h·ªèi</h6>
          <p id="statQuestions" class="fw-bold fs-5">...</p>
        </div>
        <div class="col-md-4">
          <h6>üéØ Hi·ªáu su·∫•t ph·∫£n h·ªìi t·ª´ h·ªá th·ªëng</h6>
          <p id="statEffectiveness" class="fw-bold fs-5 text-success">...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container col-md-10 form-container">
  <div class="card shadow">
    <div class="card-body">
      <h5 class="card-title text-dark">üìä Th·ªëng k√™ l·ªãch s·ª≠ tr√≤ chuy·ªán</h5>
      <div class="row">
        <div class="col-md-6">
          <div class="card shadow">
            <div class="card-body">
              <canvas id="categoryChartuser"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow">
            <div class="card-body">
              <canvas id="categoryChartassistant"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container col-md-10 form-container my-2">
  <div class="card shadow">
    <div class="card-body">
      <h5 class="card-title text-dark">üìä S·ªë l∆∞·ª£ng c√¢u h·ªèi tra c·ª©u h√†ng ng√†y</h5>
      <canvas id="chatCountByHourChart"></canvas>
    </div>
  </div>
</div>
<!-- Table hi·ªÉn th·ªã nh√≥m c√¢u tr·∫£ l·ªùi t·ª´ Chat GPT c·∫ßn x√°c th·ª±c -->
<div class="container col-md-10 form-container my-2">
  <div class="card shadow">
    <div class="card-body">
      <h5 class="card-title text-dark">üìã C√¢u tr·∫£ l·ªùi c·ªßa tr·ª£ l√Ω Chat GPT c·∫ßn ƒë∆∞·ª£c x√°c minh l·∫°i</h5>
      <table class="table table-hover mt-3">
        <thead class="table-light">
          <tr class="card-body text-dark">
            <th>C√¢u h·ªèi</th>
            <th>C√¢u tr·∫£ l·ªùi ƒë·ªÅ xu·∫•t</th>
            <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="groupsTable"></tbody>
      </table>
    </div>
  </div>
</div>
<!-- Modal nh·∫≠p chi ti·∫øt -->
<div class="modal" id="addQuestionModal">
  <div class="modal-dialog">
    <div class="modal-content p-3 text-dark">
      <h5>‚úîÔ∏è X√°c minh c√¢u tr·∫£ l·ªùi</h5>
      <div class="mb-3">
        <label>Danh m·ª•c ID</label>
        <select id="danhmuc" class="form-select"></select>
      </div>
      <div class="mb-3">
        <label>C√¢u h·ªèi</label>
        <input id="cauhoiInput" class="form-control" readonly />
      </div>
      <div class="mb-3">
        <label>C√¢u tr·∫£ l·ªùi ƒë·ªÅ xu·∫•t</label>
        <input id="cautraloidexuatInput" class="form-control" readonly />
      </div>
      <div class="mb-3">
        <label>C√¢u tr·∫£ l·ªùi x√°c minh</label>
        <textarea id="cautraloiInput" class="form-control"></textarea>
      </div>
      <div class="text-end">
        <button class="btn btn-primary" id="saveButton">L∆∞u</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
 <script>
let currentGroup = null;
async function fetchSummaryStats() {
  const res = await fetch("/api/chat_summary");
  const data = await res.json();

  animateCount(document.getElementById("statSessions"), data.total_sessions);
  animateCount(document.getElementById("statQuestions"), data.total_questions);
  animateCount(document.getElementById("statEffectiveness"), Math.round(data.effectiveness), 1000, "%");
}
async function fetchChatUser() {
    const response = await fetch("/api/getchatuser");
    const data = await response.json();
    const cleanedData = data.filter(item => item.category !== null);
    const dataWithId = cleanedData.map((item, index) => ({ id: index + 3, ...item}));

    // 2Ô∏è‚É£ Render Pie Chart
    const ctx = document.getElementById("categoryChartuser").getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: dataWithId.map(d => d.category),
        datasets: [{
          data: dataWithId.map(d => d.count),
          backgroundColor: dataWithId.map(d => createColor(d.id))
        }]
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: "T·ªâ l·ªá c√¢u h·ªèi ng∆∞·ªùi d√πng theo danh m·ª•c"
          },
          legend: {
            position: "bottom"
          }
        }
      }
    });
  }
  async function fetchChatAssistant() {
    const response = await fetch("/api/getchatassistant");
    const data = await response.json();
    const cleanedData = data.filter(item => item.category !== null);
    const dataWithId = cleanedData.map((item, index) => ({ id: index + 3, ...item}));

    // 2Ô∏è‚É£ Render Pie Chart
    const ctx = document.getElementById("categoryChartassistant").getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: dataWithId.map(d => d.category),
        datasets: [{
          data: dataWithId.map(d => d.count),
          backgroundColor: dataWithId.map(d => createColor(d.id))
        }]
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: "T·ªâ l·ªá c√¢u tr·∫£ l·ªùi theo danh m·ª•c"
          },
          legend: {
            position: "bottom"
          },
          datalabels: {
            formatter: (value, context) => {
              const sum = context.chart._metasets[0].total;
              const percentage = (value / sum) * 100;
              return `${percentage.toFixed(0)}%`;  // hi·ªÉn th·ªã 0%, 25%, 75%...
            },
            color: "#000",
            font: {
              weight: "bold",
              size: 14
            }
          }
        }
      }
    });
  }

async function loadGroups() {
  const API_URL = "http://localhost:8000";
  const res = await fetch(`${API_URL}/chat/grouped-unknown`);
  const data = await res.json();
  const tableBody = document.getElementById("groupsTable");
  tableBody.innerHTML = ""; 
  data.groups.forEach(group => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${group.representative}</td>
      <td>${group.answers}</td>
      <td>${group.count}</td>
      <td><button class="btn bg-white fs-5 d-flex justify-content-center align-items-center" onClick="openAddModal('${encodeURIComponent(group.representative)}', '${encodeURIComponent(group.answers)}', ${JSON.stringify(group.ids)})">‚úîÔ∏è X√°c minh</button></td>
    `;
    tableBody.appendChild(tr);
  });
}

function openAddModal(representative, answers, ids) {
  currentGroup = ids;
  document.getElementById("cauhoiInput").value = decodeURIComponent(representative);
  document.getElementById("cautraloidexuatInput").value = decodeURIComponent(answers);
  const modal = new bootstrap.Modal(document.getElementById("addQuestionModal"));
  modal.show();
}

document.getElementById("saveButton").addEventListener("click", async () => {
  const danhmuc = document.getElementById("danhmuc").value.trim();
  const cauhoi = document.getElementById("cauhoiInput").value.trim();
  const cauhoidexuat = document.getElementById("cautraloidexuatInput").value.trim();
  const cautraloi = document.getElementById("cautraloiInput").value.trim();

  if (!danhmuc || !cauhoi || !cautraloi || !cauhoidexuat) {
    alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin");
    return;
  }

  const resp = await fetch("/api/add_question_from_group", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({danhmuc, cauhoi, cautraloi, ids: currentGroup})
  });
  const result = await resp.json();

  if (result.success) {
    alert("‚úÖ ƒê√£ th√™m th√†nh c√¥ng!");
    loadGroups();
    bootstrap.Modal.getInstance(document.getElementById("addQuestionModal")).hide();
  } else {
    alert(result.message || "‚ùå L·ªói khi th√™m");
  }
});
async function fetchChatCountByHour() {
  const resp = await fetch("/api/chat_count_by_day");
  const data = await resp.json();

  const formattedData = data.map((item, index) => {
    const d = new Date(item.date);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = String(d.getFullYear()).slice(-2); // l·∫•y 2 ch·ªØ s·ªë cu·ªëi

    return {
      id: index + 4,
      date: `${day}/${month}/${year}`,
      count: item.count
    };
  });

  const hours = formattedData.map(d => d.date);
  const counts = formattedData.map(d => d.count);

  const ctx = document.getElementById("chatCountByHourChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: hours,
      datasets: [{
        label: "S·ªë c√¢u h·ªèi",
        data: counts,
        backgroundColor: formattedData.map(d => createColor(d.id)),
      }]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: "S·ªë l∆∞·ª£ng c√¢u h·ªèi theo ng√†y"
        },
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          title: { display: true, text: "S·ªë c√¢u" },
          beginAtZero: true
        },
        x: {
          title: { display: true, text: "Th·ªùi gian" }
        }
      }
    }
  });
}
// Khi load trang\
fetchSummaryStats();
fetchChatCountByHour();
loadDanhMuc();
fetchChatUser();
fetchChatAssistant();
loadGroups();
</script>
</body>
</html>